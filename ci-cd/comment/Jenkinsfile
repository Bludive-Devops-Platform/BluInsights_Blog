pipeline {
    agent any

    environment {
        // Path to your SOPS key and supporting info
        SOPS_AGE_KEY_FILE = '/var/lib/jenkins/.config/sops/age/keys.txt'
        CHART_PATH = "${env.WORKSPACE}/helm-charts/comment-service"
        NAMESPACE = 'bluinsights'
        DOCKERFILE = './comment-service/Dockerfile'
    }

    stages {
        stage('Decrypt Secrets') {
            steps {
                script {
                    echo "üîê Decrypting environment variables..."
                    // Decrypt the SOPS-encrypted .env file correctly
                    sh '''
                        sops --decrypt --input-type dotenv --output-type dotenv /var/lib/jenkins/secrets/devops.enc > .env
                        echo "‚úÖ Secrets decrypted to .env"
                    '''

                    // Read the decrypted .env and load variables into Jenkins environment
                    def envFile = readFile('.env').split('\n')
                    for (line in envFile) {
                        if (line && line.contains('=')) {
                            def (key, value) = line.tokenize('=')
                            env[key.trim()] = value.trim()
                        }
                    }
                    echo "‚úÖ Environment variables loaded into pipeline."
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    def IMAGE_NAME = "bludivehub/bluinsights-comment-service"
                    def IMAGE_TAG = "${IMAGE_NAME}:${env.BUILD_NUMBER}"

                    echo "üèóÔ∏è Building Docker image ${IMAGE_TAG}"
                    sh "docker build -t ${IMAGE_TAG} ./comment-service"
                }
            }
        }

        stage('Scan Docker Image for Vulnerabilities') {
            steps {
                script {
                    echo "üß™ Running Snyk scan for ${IMAGE_TAG}"
                    sh """
                        snyk auth ${env.SNYK_TOKEN}
                        snyk container test ${IMAGE_TAG} --severity-threshold=high --file=${DOCKERFILE} || true
                    """
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    echo "üöÄ Pushing Docker image ${IMAGE_TAG} to DockerHub"
                    sh """
                        echo "${env.DOCKER_PASSWORD}" | docker login -u "${env.DOCKER_USERNAME}" --password-stdin
                        docker push ${IMAGE_TAG}
                    """
                }
            }
        }

        stage('Deploy via Helm') {
            steps {
                script {
                    echo "‚öôÔ∏è Deploying comment-service via Helm..."
                    sh """
                        export KUBECONFIG=${env.KUBECONFIG_FILE}
                        helm upgrade --install comment-service ${CHART_PATH} \
                            -n ${NAMESPACE} \
                            --set image.tag=${BUILD_NUMBER} \
                            --wait
                    """
                }
            }
        }
    }

    post {
        always {
            echo "üßπ Cleaning up workspace..."
            sh "rm -f .env || true"
            sh "docker rmi ${IMAGE_TAG} || true"
        }
        success {
            echo "‚úÖ Pipeline completed successfully!"
        }
        failure {
            echo "‚ùå Pipeline failed. Check logs for details."
        }
    }
}
