pipeline {
    agent any

    environment {
        // Path to the SOPS decryption key for Age encryption
        SOPS_AGE_KEY_FILE = '/var/lib/jenkins/.config/sops/age/keys.txt'
    }

    stages {
        // Stage 1: Decrypt secrets
        stage('Decrypt Secrets') {
            steps {
                script {
                    echo "üîê Decrypting environment variables..."
                    sh '''
                        # Decrypt the SOPS-encrypted dotenv file
                        sops --decrypt --input-type dotenv /var/lib/jenkins/secrets/devops.enc > .env

                        # Export variables for subsequent stages
                        export $(grep -v '^#' .env | xargs -d '\\n')

                        echo "‚úÖ Secrets decrypted successfully."
                    '''
                }
            }
        }

        // Stage 2: Build Docker image for blog-service
        stage('Build Docker Image') {
            steps {
                script {
                    IMAGE_NAME = "bludivehub/bluinsights-blog-service"
                    IMAGE_TAG = "${IMAGE_NAME}:${env.BUILD_NUMBER}"

                    echo "üèóÔ∏è Building Docker image ${IMAGE_TAG}"
                    sh "docker build -t ${IMAGE_TAG} ./backend/blog-service"
                }
            }
        }

        // Stage 3: Scan Docker image for vulnerabilities with Snyk
        stage('Scan Docker Image for Vulnerabilities') {
            steps {
                script {
                    echo "üß™ Scanning image ${IMAGE_TAG} with Snyk"
                    sh """
                        snyk container test ${IMAGE_TAG} --severity-threshold=high --file=./backend/blog-service/Dockerfile || true
                    """
                }
            }
        }

        // Stage 4: Push Docker image to DockerHub
        stage('Push Docker Image') {
            steps {
                script {
                    echo "üì§ Pushing Docker image ${IMAGE_TAG} to DockerHub"
                    sh '''
                        source .env
                        echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
                        docker push ${IMAGE_TAG}
                    '''
                }
            }
        }

        // Stage 5: Deploy via Helm
        stage('Deploy via Helm') {
            steps {
                script {
                    echo "üöÄ Deploying Helm chart for blog-service"
                    sh '''
                        source .env
                        helm upgrade --install blog-service ./helm-charts/blog-service \
                            -n bluinsights \
                            --set image.tag=${BUILD_NUMBER} \
                            --kubeconfig="$KUBECONFIG_FILE" \
                            --wait
                    '''
                }
            }
        }
    }

    post {
        always {
            echo "üßπ Cleaning up local Docker images..."
            sh "docker rmi ${IMAGE_TAG} || true"
            sh "shred -u .env || rm -f .env"
        }
        success {
            echo "‚úÖ Pipeline compl
