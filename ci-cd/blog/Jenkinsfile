pipeline {
    agent any

    environment {
        SOPS_AGE_KEY_FILE = '/var/lib/jenkins/.config/sops/age/keys.txt'
        CHART_PATH = "${env.WORKSPACE}/helm-charts/blog-service"
        NAMESPACE = 'bluinsights'
        DOCKERFILE = './backend/blog-service/Dockerfile'
    }

    stages {
        stage('Decrypt Secrets') {
            steps {
                script {
                    echo "üîê Decrypting environment variables..."
                    // Decrypt the SOPS-encrypted .env file
                    sh 'sops --decrypt --input-type dotenv /var/lib/jenkins/secrets/devops.enc > .env'

                    // Load the decrypted .env file into Jenkins environment
                    def envFile = readFile('.env').split('\n')
                    for (line in envFile) {
                        if (line && line.contains('=')) {
                            def (key, value) = line.tokenize('=')
                            env[key.trim()] = value.trim()
                        }
                    }
                    echo "‚úÖ Secrets decrypted and loaded into pipeline environment."
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    IMAGE_NAME = "bludivehub/bluinsights-blog-service"
                    IMAGE_TAG = "${IMAGE_NAME}:${env.BUILD_NUMBER}"

                    echo "üèóÔ∏è Building Docker image ${IMAGE_TAG}"
                    sh "docker build -t ${IMAGE_TAG} ./backend/blog-service"
                }
            }
        }

        stage('Scan Docker Image for Vulnerabilities') {
            steps {
                script {
                    echo "üß™ Scanning image ${IMAGE_TAG} with Snyk"
                    sh """
                        snyk auth ${env.SNYK_TOKEN}
                        snyk container test ${IMAGE_TAG} --severity-threshold=high --docker ${IMAGE_NAME} --file=${DOCKERFILE} || true
                    """
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    echo "üöÄ Pushing Docker image ${IMAGE_TAG} to DockerHub"
                    sh """
                        echo "${env.DOCKER_PASSWORD}" | docker login -u "${env.DOCKER_USERNAME}" --password-stdin
                        docker push ${IMAGE_TAG}
                    """
                }
            }
        }

        stage('Deploy via Helm') {
            steps {
                script {
                    echo "‚öôÔ∏è Deploying Helm chart for blog-service"
                    sh """
                        export KUBECONFIG=${env.KUBECONFIG_FILE}
                        helm upgrade --install blog-service ${CHART_PATH} -n ${NAMESPACE} --set image.tag=${BUILD_NUMBER} --wait
                    """
                }
            }
        }
    }

    post {
        always {
            echo "üßπ Cleaning up local Docker images and secrets"
            sh "docker rmi ${IMAGE_TAG} || true"
            sh "shred -u .env || rm -f .env"
        }
        success {
            echo "‚úÖ Pipeline completed successfully!"
        }
        failure {
            echo "‚ùå Pipeline failed. Check logs for details."
        }
    }
}
