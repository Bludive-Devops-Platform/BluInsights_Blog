pipeline {
    agent any

    environment {
        // Path to your Age key for SOPS decryption
        SOPS_AGE_KEY_FILE = '/var/lib/jenkins/.config/sops/age/keys.txt'
        CHART_PATH = "${env.WORKSPACE}/helm-charts/blog-service"
        NAMESPACE = 'bluinsights'
        DOCKERFILE = './backend/blog-service/Dockerfile'
    }

    stages {
        stage('Decrypt Secrets') {
            steps {
                script {
                    echo "üîê Decrypting environment variables..."
                    sh '''
                        # Decrypt the SOPS-encrypted dotenv file
                        sops --decrypt --input-type dotenv /var/lib/jenkins/secrets/devops.enc > .env

                        # Export variables for subsequent stages
                        export $(grep -v '^#' .env | xargs -d '\\n')

                        echo "‚úÖ Secrets decrypted successfully."
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                script {
                    IMAGE_NAME = "bludivehub/bluinsights-blog-service"
                    IMAGE_TAG = "${IMAGE_NAME}:${env.BUILD_NUMBER}"

                    echo "üèóÔ∏è Building Docker image ${IMAGE_TAG}"
                    sh "docker build -t ${IMAGE_TAG} ./backend/blog-service"
                }
            }
        }

        stage('Scan Docker Image for Vulnerabilities') {
            steps {
                script {
                    echo "üß™ Scanning image ${IMAGE_TAG} with Snyk"
                    sh """
                        snyk auth $SNYK_TOKEN
                        snyk container test ${IMAGE_TAG} --severity-threshold=high --docker ${IMAGE_NAME} --file=${DOCKERFILE} || true
                    """
                }
            }
        }

        stage('Push Docker Image') {
            steps {
                script {
                    echo "üöÄ Pushing Docker image ${IMAGE_TAG} to DockerHub"
                    sh '''
                        . .env
                        echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
                        docker push ${IMAGE_TAG}
                    '''
                }
            }
        }

        stage('Deploy via Helm') {
            steps {
                script {
                    echo "‚öôÔ∏è Deploying Helm chart for blog-service"
                    sh '''
                        . .env
                        export KUBECONFIG=$KUBECONFIG_FILE
                        helm upgrade --install blog-service ${CHART_PATH} -n ${NAMESPACE} --set image.tag=${BUILD_NUMBER} --wait
                    '''
                }
            }
        }
    }

    post {
        always {
            echo "üßπ Cleaning up local Docker images"
            sh "docker rmi ${IMAGE_TAG} || true"
            sh "shred -u .env || rm -f .env"
        }
        success {
            echo "‚úÖ Pipeline completed successfully!"
        }
        failure {
            echo "‚ùå Pipeline failed. Check logs for errors."
        }
    }
}
